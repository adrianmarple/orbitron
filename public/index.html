<!DOCTYPE html>
<html>
<head>
<title>Super Rhombicosidodecahedron</title>
<style type="text/css">
#readyButton {
  position: fixed;
  left: 10vw;
  right: 10vw;
  bottom: 10vw;
  border: 2px solid black;
  border-radius: 12px;
  padding: 24px;
  text-align: center;
  font-size: 3em;
  cursor: pointer;
  background: white;
}
#banner {
  position: fixed;
  left: 10vw;
  right: 10vw;
  top: 10vw;
  padding: 24px;
  text-align: center;
  font-size: 3em;
  color: white;
}

.hide {
  display: none;
}
</style>
</head>
<body>

<div id="banner" class="hide">Ready!</div>
<div id="readyButton">Ready!</div>

<script>

readyButton = document.getElementById("readyButton");
banner = document.getElementById("banner");
var ws;
var IP_ADDRESS;

var xhr = new XMLHttpRequest();
xhr.open('GET', "https://rhomberman.firebaseio.com/12345.json", true);
xhr.send();

xhr.onreadystatechange = () => {
  if (xhr.readyState != 4 || xhr.status != 200) {
    return;
  }

  var response = JSON.parse(xhr.responseText);
  console.log(response.ip);

  // ws = new WebSocket("wss://" + response.ip + ":5678/");
  ws = new WebSocket("wss://raspberrypi.local:5678/");
  ws.onmessage = event => {
    console.log(event.data);
    message = JSON.parse(event.data);
    console.log(message);
    switch(message.type) {
    case "color":
      document.body.style.background = message.color;
      break;
    default:
      console.log("^^^unknown message type!^^^");
    }
  };

  ws.onerror = event => {
    console.log("WebSocket error observed");
    // TODO
  }
  ws.onclose = event => {
    console.log("WebSocket closed");
    // TODO
  }
};



function send(json) {
  ws.send(JSON.stringify(json));
}

readyButton.onclick = event => {
    send({type: "ready"});
    // readyButton.classList.add("hide");
    // banner.classList.remove("hide");
};

mousedownLocation = null;
mousedownTimestamp = 0;
onmousedown = event => {
  mousedownLocation = [event.clientX, event.clientY];
  mousedownTimestamp = Date.now();
};
ontouchstart = onmousedown;

onmouseup = event => {
  if (Date.now() - mousedownTimestamp < 200 &&
      Math.abs(mousedownLocation[0] - event.clientX) < 5 &&
      Math.abs(mousedownLocation[1] - event.clientY) < 5) {
    send({type: "tap"});
  }

  send({type: "move", move: [0,0]});
  mousedownLocation = null;
};
ontouchend = onmouseup;

onmousemove = event => {
  if (mousedownLocation == null) {
    return;
  }
  move = [mousedownLocation[0] - event.clientX, mousedownLocation[1] - event.clientY];
  send({type: "move", move});
};
ontouchmove = onmousemove;


</script>
</body>
</html>